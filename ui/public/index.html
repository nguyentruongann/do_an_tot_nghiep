
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Customer Scoring Chat</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica; margin: 40px; }
    .card { border:1px solid #ddd; padding:16px; border-radius:10px; margin:10px 0; }
    #chatbox { height: 420px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:8px; background:#fafafa}
    .u { background:#e8f0ff; display:inline-block; padding:8px 10px; border-radius:10px; margin:6px 0;}
    .b { background:#f0f0f0; display:inline-block; padding:8px 10px; border-radius:10px; margin:6px 0;}
    small.hint { color:#666;}
  </style>
  <script>window.API_BASE="__API_BASE__";</script>
</head>
<body>
  <h2>üí¨ Customer Scoring Chat</h2>

  <div class="card">
    <h3>1) T·∫°o phi√™n & t·∫£i d·ªØ li·ªáu (CSV/XLSX/Parquet)</h3>
    <form id="upform">
      <input type="file" id="file" required />
      <button type="submit">Upload</button>
      <button type="button" onclick="newSession()">Phi√™n m·ªõi</button>
      <span id="status" class="hint"></span>
    </form>
    <small class="hint">Ch·ªâ tr·∫£ l·ªùi v·ªÅ ch·∫•m ƒëi·ªÉm (score, top-k, gi·∫£i th√≠ch, ROC, ng∆∞·ª°ng...). C√¢u h·ªèi kh√°c s·∫Ω b·ªã t·ª´ ch·ªëi.</small>
  </div>

  <div class="card">
    <h3>2) Chat</h3>
    <div>
      <button onclick="scoreNow()">Ch·∫•m ƒëi·ªÉm</button>
      <a id="dl" href="#" target="_blank">T·∫£i CSV ƒë√£ ch·∫•m</a>
    </div>
    <div id="chatbox"></div>
    <div style="margin-top:8px;">
      <input id="msg" placeholder="G√µ c√¢u h·ªèi v·ªÅ ch·∫•m ƒëi·ªÉm..." style="width:80%"/>
      <button onclick="send()">G·ª≠i</button>
    </div>
  </div>

<script>
const API = (window.API_BASE && window.API_BASE !== "__API_BASE__") ? window.API_BASE : "http://localhost:8080";
let SID = null;
function el(id){return document.getElementById(id)}
function append(role, text){
  const div=document.createElement('div'); div.className=role==='u'?'u':'b'; div.textContent=text;
  const box=el('chatbox'); box.appendChild(div); box.scrollTop=box.scrollHeight;
}
async function newSession(){
  const r = await fetch(API+'/session/new', {method:'POST', credentials:'include'});
  const j = await r.json(); SID = j.session_id; el('status').textContent = ' Phi√™n: '+SID;
  localStorage.setItem('sid', SID); append('b','Phi√™n m·ªõi ƒë√£ t·∫°o. H√£y upload d·ªØ li·ªáu c·ªßa b·∫°n.');
}
async function ensureSession(){
  SID = localStorage.getItem('sid');
  if (!SID){ await newSession(); }
  return SID;
}
document.getElementById('upform').addEventListener('submit', async (e)=>{
  e.preventDefault(); await ensureSession();
  const f = el('file').files[0]; if(!f){ alert('Ch·ªçn file tr∆∞·ªõc'); return; }
  const form = new FormData(); form.append('file', f);
  const r = await fetch(API+'/upload_session', {method:'POST', body: form, credentials:'include'});
  const j = await r.json();
  if (j.detail){ append('b', 'L·ªói upload: '+JSON.stringify(j.detail)); return; }
  append('b', 'ƒê√£ upload: '+(j.filename||'')+' ('+j.rows+' d√≤ng). V√≠ d·ª• h·ªèi: "ai l√† kh√°ch h√†ng ti·ªÅm nƒÉng top 5", "v√¨ sao id=1 l√† ti·ªÅm nƒÉng?".');
});
async function send(){
  await ensureSession();
  const msg = el('msg').value.trim(); if(!msg) return;
  append('u', msg); el('msg').value='';
  const r = await fetch(API+'/chat', {method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg})});
  const j = await r.json(); append('b', j.text || JSON.stringify(j));
}
async function scoreNow(){
  await ensureSession();
  const r = await fetch(API+'/score_session', {method:'POST', credentials:'include'});
  const j = await r.json();
  if (j.detail){ append('b','L·ªói: '+JSON.stringify(j.detail)); return; }
  append('b','ƒê√£ ch·∫•m '+j.rows+' d√≤ng.'); el('dl').href = API + '/download_scored_session';
}
(async()=>{ await ensureSession(); })();
</script>
</body>
</html>
